---
title: "Health dimensions by regimes"
author: "Maria Potterf"
date: "August 5, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Forest health indicators for SIMO


- **Shelter**:   even/uneven aged forest: even-aged= if 80% of the volume is located in age classes 20 years apart
- **Serenity**:  if distant > 400m from road at 70km/h
- **Diversity**: Volume for individual species & count; Volume share by species? If > 70%, then not a diverse forest
- **Nature**:    mean age > 100 years; Age_VOL, Age_BA (lower than Age_vol)
- **Cohesion**:  stand area > 1 ha

### How to combine dimensions? 

- **Edges/glades**:    shelter, nature, diversity
- **Deep forest**:     nature, shelter, serenity
- **Spacious forest**: cohesion, serenity, nature


### Forest management regimes:

Select the most diverse management regimes: 

- **BAU** - business as usual: final cut, including thinnings
- **CCF** - continuous cover forestry, no final cut
- **SA**  - set aside, no harvest

Variation in regimes:

- in rotation length
- in final harvest type (yes, no, green tree retention)
- variation in thinnings: no thinnings

``` {r read-libs, include=FALSE}
rm(list = ls())

#setwd("C:/MyTemp/myGitLab/windDamage")

# Read libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(sf)
library(rgdal)
library(dplyr)
library(spData)
library(sf)
library(purrr)

```

# New indicators from SIMO output querry calculated for health purposes:

###  Naturalness: 
"AGE_vol" - age weighthed by volume                   
"AGE_ba"  - age weighthed by basal area

### Shelter:
"quality" - even/uneven age: even-age = if 80% of volume is located within range of 20 years

Presence of the layers of less then 2 m: classify to present/absent

"Layers_lt_2m"    - number of layers under 2 m          
"Layers_lt_2m_N"  - number of stems/ha under 2 m
"Layers_lt_5m"    - number of layers under 5 m         
"Layers_lt_5m_N"  - number of stems/ha under 5 m

### Diversity: 
- mixed if less then 70% of teh volume belong to one species

Tree species: 

by volume

"V_pine"                    "V_spruce"                 
"V_Birch_1"                 "V_Birch_2"                
"V_populus"                 "V_Alnus_incana"           
"V_Alnus_glutinosa"         "V_o_coniferous"           
"V_o_decidious"                               
          
       




```{r get-data, include=FALSE}

inPath = "C:/MyTemp/myGitLab/bayesianESS/build_ess_models_bayesian"
inFolder = "input"

# Read data
df <- data.table::fread(paste(inPath, 
                              inFolder, 
                              "RCP85_p_301-600_l3.csv",  
                              sep = "/"),  
                        data.table=FALSE, stringsAsFactors = FALSE)



# Filter data first
my_regimes = c("SA_DWextract", "BAU",  "CCF", "BAUwT_GTR")
my_cols = c("id",
           "year",
           'AREA',
           "branching_group", 
           "Age", 
           "BA", 
            "V", 
           #"Harvested_V_log",
           #"Harvested_V_pulp", 
          #"PEAT",
            "H_dom"  ,
            # "D_gm", 
            #     "COMBINED_HSI"  
            "AGE_vol", 
            #"AGE_ba", 
            "V_pine",
           "V_spruce",
           "V_Birch_1",
           "V_Birch_2",
           "V_populus",
           "V_Alnus_incana",
           "V_Alnus_glutinosa",
           "V_o_coniferous",
           "V_o_decidious",
           "quality",
           "Layers_lt_2m",
           "Layers_lt_5m",
           "Layers_lt_2m_N",
           "Layers_lt_5m_N",
            "name", 
           "regime")


df <- df %>% 
  filter(regime %in% my_regimes) %>% 
  dplyr::select(all_of(my_cols))


#str(df)




```


'quality' variable contains many NA values: these follows recent harvest, e.g. H_dom (tree height) is NA or very low. Consider these as 'no forest', or keep as NA
  

# Calculate the % of species by volume

if any of the species has more that > 70% of volume, that the stands is not mixed = not diverse


```{r get-metrics, include=FALSE}
# Calculate the volume proportion by species, V = total volume
# count how many species are present = richness
# e.g. count number of species (= columns) that volume is not NA

library(dplyr)

cols_species = c(
  'V_pine',
  'V_spruce',
  'V_Birch_1',
  'V_Birch_2',
  'V_populus',
  'V_Alnus_incana',
  'V_Alnus_glutinosa',
  'V_o_coniferous',
  'V_o_decidious'
)



# Count number or columns that have some volume (exist) in a stand
df$richness <- rowSums( !is.na( select(df, all_of(cols_species))))


# Get proportion of volume per species from total volume: `V`
# select all columns containing species and divide it bu total volume
# reclassify based on rule: diverse if <70% of volume is made by one species
df.V.prop = select(df, all_of(cols_species))/df$V*100


# Classify as mixed/no mixed if any of species column have less then 70% of volume in single species 
df$q_mixed <- 
  df.V.prop %>%
   rowwise() %>%
  mutate(q_mixed = case_when(all(is.na(c_across())) ~ NA_character_, 
                            any(c_across() >= 70) ~ 'uniform', 
                            TRUE ~ 'mixed')) %>% 
    pull(q_mixed)


```



### Dimensions

#### Shelter:

- if quality is uneven-aged and have a any layers in the height of 2m:


```{r shelter, echo=FALSE, fig.dim = c(3, 3), include=FALSE}

# Classify sheltering

df <- 
  df %>% 
  mutate(shelter = case_when(
    (quality == "uneven-aged" & "Layers_lt_2m" >= 1) ~ 1, 
    TRUE ~0 )) 

```



#### Serenity: 

- distance from major roads
- Daniel show road network over the forest stand geometry?
- also 
0 - within 400 m from the road of 70km/ha max speed
1 - more then 400 m away (edge-to-edge or centroid distance??)

#### Diversity:  

- diverse if species are mixed (e.g. >70% of the species volume is created by more then one species)


```{r diversity, echo=FALSE, fig.dim = c(3, 3), include=FALSE}

# Classify diversity

df <- 
  df %>% 
  mutate(divers = case_when(
    q_mixed == "mixed" ~ 1, 
    TRUE~ 0)) 

```



#### Naturalness: 

- age > 100 years old (100-140)

Mean age of all stands is  `r round(mean(df$AGE_vol), 1)` years old. Distribution by regimes: 

```{r hist-age, echo=FALSE, fig.dim = c(7, 2.5), message=FALSE}

df %>% 
  ggplot(aes(x = AGE_vol,
             fill = regime)) +
  geom_histogram() +
  geom_vline(xintercept = 100) + 
  facet_grid(.~regime) +
     theme(legend.position = 'bottom') +
  theme_classic()
 

```

#### Cohesion:

- stands over 1 ha 

Mean stand area is `r round(mean(df$AREA, na.rm = T), 1)` ha. 

```{r hist-AREA, echo=FALSE, fig.dim = c(3, 2.5), message=FALSE}

df %>% 
  filter(year == 2016 & regime == "BAU") %>% 
  ggplot(aes(x = AREA,
             fill = regime)) +
  geom_histogram() +
  #geom_vline(xintercept = 20) + 
  theme_classic() +
   theme(legend.position = 'none') +
  xlab("area (ha)") 
 
```


